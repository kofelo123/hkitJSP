<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"  import="java.sql.*,java.util.*,java.text.*"%>
<% request.setCharacterEncoding("utf-8"); %>
<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
<title>Insert title here</title>
<script>
	function check(id){
			pass = prompt('수정/삭제시 비밀번호입력');
			location.href="addr_modify.jsp?id="+id+"&pass="+pass;
		}

	function search(){
		with(document.search){
			if(val.value.length == 0){
				alert("검색어를 입력해 주세요!!");
				val.focus();
				return false;
				}
				document.search.submit();
			}
		}
</script>
</head>

<body>
<div align="center">
<h1>주소록:목록화면</h1>
<hr>
<a href="addr_insert.jsp">주소록 등록</a><br><br>		
<form method="post" name="search" action="list.jsp">
<tr>
	<td align="right" width="241">
		<select name="search">
			<option value="name">이름
			<option value="company">회사
			<option value="memo">메모
			<option value="nameMemo">이름+메모
		</select>
	</td>
	<td width="127" align="center">
		<input type="text" size="17" name="val">
	</td>
	<td width="115"><input type="button" value="검색" onClick="search();"></a></td>
	
</tr>

</form>
<table width="800" border='1' style="text-align:center;background-color:#7ec6ef;color:white;border-color:blue;">

	<tr>
	<td>번호</td>
	<td>이 름</td>
	<td>전화번호</td>
	<td>생 일</td>
	<td>회 사</td>
	<td>메 모</td>
	</tr>
	<%
	Vector id= new Vector();
	Vector name= new Vector();
	Vector phonenum= new Vector();
	Vector birthday= new Vector();
	Vector company= new Vector();
	Vector memo= new Vector();
	Vector email=new Vector();
	
	int where = 1;
	
	int totalgroup=0;
	int maxpages=5;
	int startpage=1;
	int endpage=startpage+maxpages-1;
	int wheregroup=1;
	
	

	if(request.getParameter("go") != null){ //페이지번호 링크를 누를때 go값 전달됨. -> where로 저장.
		where = Integer.parseInt(request.getParameter("go"));
		wheregroup = (where-1)/maxpages + 1;
		startpage=(wheregroup-1) * maxpages+1;
		endpage=startpage+maxpages-1;
	}else if (request.getParameter("gogroup") != null){//다음,이전,처음 ,마지막 링크누를시에 gogroup값 전달 -> wheregroup을 gogroup값을 변경한다.
		wheregroup = Integer.parseInt(request.getParameter("gogroup"));
		startpage=(wheregroup-1) * maxpages+1;
		where = startpage;
		endpage=startpage+maxpages-1;
	}
	
	int nextgroup = wheregroup + 1;
	int priorgroup = wheregroup-1;
	int startrow=0;
	int endrow=0;
	int maxrows=5;
	int totalrows=0;
	int totalpages=0;
	
	Connection con = null;
	PreparedStatement pstmt = null;
	ResultSet rs = null;
	String sql="";
	String searchSql="";
	try{
		Class.forName("com.mysql.jdbc.Driver");
	}catch(ClassNotFoundException e){
		e.printStackTrace();
	}
	
	try{
		con = DriverManager.getConnection("jdbc:mysql://localhost:3306/addr","hkitJeongwon","gj0123");
	}catch(SQLException e){
		e.printStackTrace();
	}
	
	try{
		String val=request.getParameter("val");
		System.out.println(val);
		if(val !=null){
			String searchVal=request.getParameter("search");
			switch(searchVal){
			case "name":
				searchSql=" where name ='"+val+"'";
				break;
			case "company":
				searchSql=" where campany like ='"+val+"'";
				break;
			case "content":
				searchSql=" where content like '%"+val + "%'";
				break;
			case "nameContent":
				searchSql=" where name ='"+val+"'";
				searchSql=searchSql+" or content like '%"+val + "%'";
				break;
			}
		}
		sql="select * from addrbook"+ searchSql +" order by id desc";
		pstmt=con.prepareStatement(sql);
		rs=pstmt.executeQuery();
		if(!(rs.next())){
			out.println("주소록 데이터가 존재하지 않습니다.");
		}
		do{
			id.addElement(rs.getString("id"));
			name.addElement(rs.getString("name"));
			phonenum.addElement(rs.getString("phonenum"));
			birthday.addElement(rs.getString("birthday"));
			company.addElement(rs.getString("company"));
			memo.addElement(rs.getString("memo"));
			email.addElement(rs.getString("email"));
		}while(rs.next());
		totalrows = id.size();
		totalpages = (totalrows-1)/maxrows +1;
		startrow = (where-1) * maxrows;
		endrow=startrow+maxrows-1;
		if(endrow >= totalrows)
			endrow=totalrows-1;
		totalgroup = (totalpages-1)/maxpages +1;
		if(endpage>totalpages)
			endpage=totalpages;
		
		for(int j=startrow; j<=endrow;j++){
		out.println("<tr>");
		out.println("<td>");																											
		%>  
		<a href="javascript:check(<%= id.elementAt(j)%>)" style='text-decoration:none'><%= id.elementAt(j)%></a></td>
		<%
		out.println("<td>");
		out.println(name.elementAt(j)+"</td>");
		out.println("<td>");
		out.println(phonenum.elementAt(j)+"</td>");
		out.println("<td>");
		out.println(birthday.elementAt(j)+"</td>");
		out.println("<td>");
		out.println(company.elementAt(j)+"</td>");
		out.println("<td>");
		out.println(memo.elementAt(j)+"</td>");
		out.println("</tr>");
		}
		out.println("</table>");
		rs.close();
		pstmt.close();
		con.close();
	}catch(SQLException e){
		e.printStackTrace();
	}
	
	if(wheregroup > 1){
		
		out.print("[<a href=list.jsp?gogroup=1>처음</a>]");
		out.print("[<a href=list.jsp?gogroup="+priorgroup+">이전</a>]");
	}else{
		System.out.println("where group:"+wheregroup);
		out.println("[처음]");
		out.println("[이전]"); }
	
	
	if(id.size() !=0){
		for(int jj=startpage; jj<=endpage; jj++){
			if(jj==where){
				System.out.println("j-value:"+jj);
				System.out.println("where:"+where);
				out.println("["+jj+"]");
				
			}
			else{
				out.print("<a href=list.jsp?go="+jj+">["+jj+"]</a>");
		}
		
		}
	}
	if(wheregroup < totalgroup){
		out.print("[<a href=list.jsp?gogroup=" + nextgroup+">다음</a>]");
		out.print("[<a href=list.jsp?gogroup="+ totalgroup+">마지막</a>]");
	}else{
		out.println("[다음]");
		out.println("[마지막]");
	}
	out.println("전체 방명록수 :"+totalrows);

%>



</div>
</body>
</html>